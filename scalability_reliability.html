

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Scalability, Reliability and a Production environment &mdash; How to create high scalable web-backends for ios developers 0.0.0 documentation</title>
    
    <link rel="stylesheet" href="_static/lovelydoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="How to create high scalable web-backends for ios developers 0.0.0 documentation" href="index.html" />
    <link rel="prev" title="Login within the iOS application" href="frontend_login.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="frontend_login.html" title="Login within the iOS application"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">How to create high scalable web-backends for ios developers 0.0.0 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="document">
      <div class="documentwrapper">
        
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Scalability, Reliability and a Production environment</a><ul>
<li><a class="reference internal" href="#reliability">Reliability</a></li>
<li><a class="reference internal" href="#scalability">Scalability</a><ul>
<li><a class="reference internal" href="#extending-the-crate-cluster">Extending the crate cluster</a></li>
<li><a class="reference internal" href="#adding-an-app-instance">Adding an app instance</a></li>
</ul>
</li>
<li><a class="reference internal" href="#production-environment">Production Environment</a><ul>
<li><a class="reference internal" href="#web-server">Web Server</a></li>
<li><a class="reference internal" href="#crate-multicast">Crate Multicast</a></li>
<li><a class="reference internal" href="#extending-the-production-cluster">Extending the production cluster</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="frontend_login.html"
                        title="previous chapter">Login within the iOS application</a></p>
    <div id="searchbox">
      <h3>Quick search</h3>
        <form class="search" action="search.html" method="get">
          <div class="searchfield">
            <input type="text" name="q" />
            <input type="submit" value="" />
          </div>
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
        </form>
        <p class="searchtip" style="font-size: 90%">
        Enter search terms or a module, class or function name.
        </p>
    </div>
        </div>
      </div>
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="scalability-reliability-and-a-production-environment">
<h1>Scalability, Reliability and a Production environment<a class="headerlink" href="#scalability-reliability-and-a-production-environment" title="Permalink to this headline">¶</a></h1>
<p>In <a class="reference internal" href="setup.html"><em>Setup Your First Application</em></a> we touched the topology a bit. We also mentioned that you can
stop the haproxy and an app instance during development. So the topology you
used looked like:</p>
<p class="plantuml">
<img src="_images/plantuml-09dcdf969dca0b28fe2c21df9681dc635c8e3083.png" alt="package &quot;localhost&quot; {
    [app - 9210] as ap1
    [crate 4200] as cr1
}

ap1 --&gt; cr1" />
</p>
<p>Supervisord starts a haproy, two crate and two app instances. So the topology
looks like:</p>
<p class="plantuml">
<img src="_images/plantuml-208a66cd7de140a9ba6d65a7b9278b7baf6c58a5.png" alt="package &quot;localhost&quot; {
    [haproxy - 9100] as ha1
    [app - 9210] as ap1
    [crate - 4200] as cr1

    [app - 9211] as ap2
    [crate - 4201] as cr2

}

ha1 --&gt; ap1
ha1 --&gt; ap2

ap1 --&gt; cr1
ap1 --&gt; cr2

ap2 --&gt; cr1
ap2 --&gt; cr2" />
</p>
<div class="section" id="reliability">
<h2>Reliability<a class="headerlink" href="#reliability" title="Permalink to this headline">¶</a></h2>
<p>Within this topology there are two app instances as well as two crate instances.
To benefit from this redundancy we have to use the haproxy url in the iOS app.
Open the <cite>AppDelegate</cite> and change the base url in <cite>setUpRestKit</cite> to:</p>
<div class="highlight-python"><pre>@"http://localhost:9100"</pre>
</div>
<p>Now you can simulate a server failure by shutting down an app instance:</p>
<div class="highlight-python"><pre>bin/supervisorctl stop app:app_9210</pre>
</div>
<p>The status interface for the HAProxy is available at
<a class="reference external" href="http://localhost:9100/__haproxy_stats">http://localhost:9100/__haproxy_stats</a> and it shows that the app
instance is down.
But for all that the iOS app works properly because there is a working
app instance left and HAProxy routes all incoming requests to it.</p>
<p>Just as well it&#8217;s possible to stop a crate instance:</p>
<div class="highlight-python"><pre>bin/suervisorctl stop crate:crate_4200</pre>
</div>
<p>The crate admin interface is available at <a class="reference external" href="http://localhost:4201/admin">http://localhost:4201/admin</a>.
After stopping the crate instance the cluster state turns yellow but the cluster
is still working.</p>
<p>If you start the crate instance again the cluster state turns green:</p>
<div class="highlight-python"><pre>bin/supervisorctl start "crate:*"</pre>
</div>
</div>
<div class="section" id="scalability">
<h2>Scalability<a class="headerlink" href="#scalability" title="Permalink to this headline">¶</a></h2>
<div class="section" id="extending-the-crate-cluster">
<h3>Extending the crate cluster<a class="headerlink" href="#extending-the-crate-cluster" title="Permalink to this headline">¶</a></h3>
<p>To extend your local crate cluster open <cite>etc/supervisord.conf</cite> and increase
the <cite>numprocs</cite> within the crate section:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">numprocs</span><span class="o">=</span><span class="mi">3</span>
</pre></div>
</div>
<p>Then update the supervisor:</p>
<div class="highlight-python"><pre>$sh bin/supervisorctl update
crate: stopped
crate: updated process group</pre>
</div>
<p>Alternatively or additional you can start a new instance in foreground:</p>
<div class="highlight-python"><pre>$sh parts/crate/bin/crate -f -Des.config=etc/crate.yml</pre>
</div>
<p>Open the crate admin interface and switch to <cite>Cluster</cite>. You will see that the
new node was added to the cluster:</p>
<div class="highlight-python"><pre>http://localhost:4200/_plugin/crate-admin/#/cluster</pre>
</div>
<p>Also add the new node to your app config <cite>etc/development.conf</cite> and restart the
app instances:</p>
<div class="highlight-python"><pre>crate.hosts = localhost:4200 localhost:4201 localhost:4202</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The new node becomes part of the crate cluster anyway, even if you don&#8217;t
add it to the app configuration.
But if the other crate nodes fails out the app server can&#8217;t establish
a connection to the remaining node.</p>
</div>
</div>
<div class="section" id="adding-an-app-instance">
<h3>Adding an app instance<a class="headerlink" href="#adding-an-app-instance" title="Permalink to this headline">¶</a></h3>
<p>To add an app instance edit <cite>etc/supervisord.conf</cite> and increase the <cite>numprocs</cite>
within the app section:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">numprocs</span><span class="o">=</span><span class="mi">3</span>
</pre></div>
</div>
<p>Then run supervisor update:</p>
<div class="highlight-python"><pre>$sh bin/supervisorctl update
app: stopped
app: updated process group</pre>
</div>
<p>Alternatively you can start a new app instance in foreground:</p>
<div class="highlight-python"><pre>$sh bin/app http_port=9212</pre>
</div>
<p>Then you have to add the new instance to the <cite>haproxy</cite> conf in
<cite>etc/haproxy.conf</cite>:</p>
<div class="highlight-python"><pre>server ap_ap1_localhost localhost:9210 minconn 5 maxconn 50 check
server ap_ap2_localhost localhost:9211 minconn 5 maxconn 50 check
server ap_ap3_localhost localhost:9212 minconn 5 maxconn 50 check</pre>
</div>
<p>Restart the <cite>haproxy</cite>:</p>
<div class="highlight-python"><pre>bin/supervisorctl restart haproxy</pre>
</div>
<p>The status interface for the HAProxy shows that the new node was added:</p>
<div class="highlight-python"><pre>http://localhost:9100/__haproxy_stats</pre>
</div>
</div>
</div>
<div class="section" id="production-environment">
<h2>Production Environment<a class="headerlink" href="#production-environment" title="Permalink to this headline">¶</a></h2>
<p>The local environment is just a representation of an environment you may use
for production. For production you will distribute the app and crate instances
to at least two hosts on different physical machines:</p>
<p class="plantuml">
<img src="_images/plantuml-93e4755f2cb5456d3900ec370af7c24314c3cb5e.png" alt="package &quot;Host 1&quot; {
    [app - 9210] as ap1
    [haproxy 9100] as ha1
    [crate 4200] as cr1
}

package &quot;Host 2&quot; {
    [app - 9210] as ap2
    [haproxy 9100] as ha2
    [crate 4200] as cr2
}

ap1 --&gt; cr1
ap1 --&gt; cr2

ap2 --&gt; cr1
ap2 --&gt; cr2

ha1 --&gt; ap1
ha1 --&gt; ap2

ha2 --&gt; ap2
ha2 --&gt; ap1

cr1 ..&gt; cr2
cr2 ..&gt; cr1" />
</p>
<div class="section" id="web-server">
<h3>Web Server<a class="headerlink" href="#web-server" title="Permalink to this headline">¶</a></h3>
<p>Of course you should not expose the haproxy directly. So add a reverse proxy
like <a class="reference external" href="http://nginx.org">nginx</a>:</p>
<p class="plantuml">
<img src="_images/plantuml-6705e1ac4ecd20ba075b2f11420ef6b8705ddedb.png" alt="[Firewall] as fl
[Load Balancer] as lb

package &quot;Host 1&quot; {
    [nginx - 80] as rp1
    [app - 9210] as ap1
    [haproxy - 9100] as ha1
    [crate - 4200] as cr1
}

package &quot;Host 2&quot; {
    [nginx - 80] as rp2
    [app - 9210] as ap2
    [haproxy - 9100] as ha2
    [crate - 4200] as cr2
}

fl -&gt; lb

lb --&gt; rp1
lb --&gt; rp2

rp1 --&gt; ha1
rp2 --&gt; ha2

ap1 --&gt; cr1
ap1 --&gt; cr2

ap2 --&gt; cr1
ap2 --&gt; cr2

ha1 --&gt; ap1
ha1 --&gt; ap2

ha2 --&gt; ap2
ha2 --&gt; ap1

cr1 ..&gt; cr2
cr2 ..&gt; cr1" />
</p>
</div>
<div class="section" id="crate-multicast">
<h3>Crate Multicast<a class="headerlink" href="#crate-multicast" title="Permalink to this headline">¶</a></h3>
<p>Within <cite>etc/crate.yml</cite> zen.multicast can be disabled:</p>
<div class="highlight-python"><pre>path:
    logs:  ...
    data:  ...
discovery:
    type: zen
    zen:
        ping:
            multicast:
                enabled: false
cluster:
    name: microblog-dev</pre>
</div>
<p>If you disable multicast you have to pass the ports and the list of other
crate hosts:</p>
<div class="highlight-python"><pre>parts/crate/bin/crate -f -Des.config=etc/crate.yml -Des.http.port=4202 -Des.discovery.zen.ping.unicast.hosts=localhost:4300 localhost:4301 -Des.transport.tcp.port=4302</pre>
</div>
<p>We recommend to enable multicast within your production cluster. For development
you can disable multicast if you want to prevent your local cluster from
connecting with other crate nodes in your network, which may disturb your
coworkers.</p>
</div>
<div class="section" id="extending-the-production-cluster">
<h3>Extending the production cluster<a class="headerlink" href="#extending-the-production-cluster" title="Permalink to this headline">¶</a></h3>
<p>As you can just start new app and crate instances you can add new hosts to your
cluster in multiple ways. You can just add a new host with a nginx, haproxy,
app and crate:</p>
<p class="plantuml">
<img src="_images/plantuml-fdb2e2720b736d48a8108f5ed31202bafbf05e73.png" alt="[Firewall] as fl
[Load Balancer] as lb

package &quot;Host 1&quot; {
    [nginx - 80] as rp1
    [app - 9210] as ap1
    [haproxy - 9100] as ha1
    [crate - 4200] as cr1
}

package &quot;Host 2&quot; {
    [nginx - 80] as rp2
    [app - 9210] as ap2
    [haproxy - 9100] as ha2
    [crate - 4200] as cr2
}

package &quot;Host 3&quot; {
    [nginx - 80] as rp3
    [app - 9210] as ap3
    [haproxy - 9100] as ha3
    [crate - 4200] as cr3
}

fl -&gt; lb

lb --&gt; rp1
lb --&gt; rp2
lb --&gt; rp3

rp1 --&gt; ha1
rp2 --&gt; ha2
rp3 --&gt; ha3

ap1 --&gt; cr1
ap1 --&gt; cr2
ap1 --&gt; cr3

ap2 --&gt; cr1
ap2 --&gt; cr2
ap2 --&gt; cr3

ap3 --&gt; cr1
ap3 --&gt; cr2
ap3 --&gt; cr3

ha1 --&gt; ap1
ha1 --&gt; ap2
ha1 --&gt; ap3

ha2 --&gt; ap2
ha2 --&gt; ap1
ha2 --&gt; ap3

ha3 --&gt; ap2
ha3 --&gt; ap1
ha3 --&gt; ap3" />
</p>
<p>Alternatively you can distribute the services to different hosts:</p>
<p class="plantuml">
<img src="_images/plantuml-c57305aba0c9ddb041ea9219fa986008532c342d.png" alt="[Firewall] as fl
[Load Balancer] as lb

package &quot;rp host1&quot; {
    [nginx - 80] as rp1
    [haproxy - 9100] as ha1
}

package &quot;app host1&quot; {
    [app - 9210] as ap1
}

package &quot;crate host1&quot; {
    [crate - 4200] as cr1
}

package &quot;rp host2&quot; {
    [nginx - 80] as rp2
    [haproxy - 9100] as ha2
}

package &quot;app host2&quot; {
    [app - 9210] as ap2
}

package &quot;crate host2&quot; {
    [crate - 4200] as cr2
}

fl -&gt; lb

lb --&gt; rp1
lb --&gt; rp2

rp1 --&gt; ha1
rp2 --&gt; ha2

ap1 --&gt; cr1
ap1 --&gt; cr2

ap2 --&gt; cr1
ap2 --&gt; cr2

ha1 --&gt; ap1
ha1 --&gt; ap2

ha2 --&gt; ap2
ha2 --&gt; ap1

cr1 ..&gt; cr2
cr2 ..&gt; cr1" />
</p>
<p>These are just a few examples for possible setups. You can adapt and combine
them to fit your needs.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="frontend_login.html" title="Login within the iOS application"
             >previous</a> |</li>
        <li><a href="index.html">How to create high scalable web-backends for ios developers 0.0.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Lovely Systems.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>